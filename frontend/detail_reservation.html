<!DOCTYPE html>
<html lang="zxx">
  <head>
    <title>Rentaly - Multipurpose Vehicle Car Rental Website Template</title>
    <link rel="icon" href="images/icon.png" type="image/gif" sizes="16x16" />
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta
      content="Rentaly - Multipurpose Vehicle Car Rental Website Template"
      name="description"
    />
    <meta content="" name="keywords" />
    <meta content="" name="author" />
    <!-- CSS Files
    ================================================== -->
    <link
      href="css/bootstrap.min.css"
      rel="stylesheet"
      type="text/css"
      id="bootstrap"
    />
    <link href="css/mdb.min.css" rel="stylesheet" type="text/css" id="mdb" />
    <link href="css/plugins.css" rel="stylesheet" type="text/css" />
    <link href="css/style.css" rel="stylesheet" type="text/css" />
    <link href="css/coloring.css" rel="stylesheet" type="text/css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css"
    />

    <!-- color scheme -->
    <link
      id="colors"
      href="css/colors/scheme-01.css"
      rel="stylesheet"
      type="text/css"
    />
  </head>
  <body>
    <div id="wrapper">
      <!-- Header identique à car-single.html -->

      <!-- header begin -->
      <header class="transparent scroll-light has-topbar">
        <div id="topbar" class="topbar-dark text-light">
          <div class="container">
            <div class="topbar-left xs-hide">
              <div class="topbar-widget">
                <div class="topbar-widget">
                  <a href="#"><i class="fa fa-phone"></i>+208 333 9296</a>
                </div>
                <div class="topbar-widget">
                  <a href="#"
                    ><i class="fa fa-envelope"></i>contact@rentaly.com</a
                  >
                </div>
                <div class="topbar-widget">
                  <a href="#"
                    ><i class="fa fa-clock-o"></i>Mon - Fri 08.00 - 18.00</a
                  >
                </div>
              </div>
            </div>

            <div class="topbar-right">
              <div class="social-icons">
                <a href="#"><i class="fa fa-facebook fa-lg"></i></a>
                <a href="#"><i class="fa fa-twitter fa-lg"></i></a>
                <a href="#"><i class="fa fa-youtube fa-lg"></i></a>
                <a href="#"><i class="fa fa-pinterest fa-lg"></i></a>
                <a href="#"><i class="fa fa-instagram fa-lg"></i></a>
              </div>
            </div>
            <div class="clearfix"></div>
          </div>
        </div>
        <div class="container">
          <div class="row">
            <div class="col-md-12">
              <div class="de-flex sm-pt10">
                <div class="de-flex-col">
                  <div class="de-flex-col">
                    <!-- logo begin -->
                    <div id="logo">
                      <a href="index.html">
                        <img
                          class="logo-1"
                          src="images/logo-light.png"
                          alt=""
                        />
                        <img class="logo-2" src="images/logo.png" alt="" />
                      </a>
                    </div>
                    <!-- logo close -->
                  </div>
                </div>
                <div class="de-flex-col header-col-mid">
                  <ul id="mainmenu">
                    <li>
                      <a class="menu-item" href="index.html">Accueil</a>
                    </li>
                    <li>
                      <a class="menu-item" href="cars.html">Voitures</a>
                    </li>
                    <li>
                      <a class="menu-item" href="cars.html">Contact</a>
                    </li>
                  </ul>
                </div>
                <div class="de-flex-col">
                  <div class="menu_side_area" id="loginUI">
                    <a href="login.html" class="btn-main">Se connecter</a>
                    <span id="menu-btn"></span>
                  </div>
                  <div class="menu_side_area" id="accountUI">
                    <div class="de-login-menu">
                      <span id="de-click-menu-profile" class="de-menu-profile">
                        <img
                          src="images/profile/1.jpg"
                          class="img-fluid photo"
                          alt=""
                        />
                      </span>

                      <div id="de-submenu-profile" class="de-submenu">
                        <div class="d-name">
                          <h4 class="nom">Monica Lucas</h4>
                          <span class="text-gray email"></span>
                          <span class="text-gray role"></span>
                        </div>

                        <div class="d-line"></div>

                        <ul class="menu-col">
                          <li>
                            <a
                              href="account-dashboard.html"
                              id="accountRedirect"
                              ><i class="fa fa-home"></i>Tableau de bord</a
                            >
                          </li>
                          <li>
                            <a href="account-profile.html"
                              ><i class="fa fa-user"></i>Mon profile</a
                            >
                          </li>
                          <li>
                            <span class="deconnexion"
                              ><i class="fa fa-sign-out"></i> Se
                              deconnecter</span
                            >
                          </li>
                        </ul>
                      </div>
                      <span id="menu-btn"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>
      <!-- header close -->

      <!-- Contenu principal -->
      <section id="subheader" class="jarallax text-light">
        <img src="images/background/3.jpg" class="jarallax-img" alt="" />
        <div class="center-y relative text-center">
          <div class="container">
            <div class="row">
              <div class="col-md-12 text-center">
                <h1>Détails de votre réservation</h1>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="section-reservation-details" class="no-top no-bottom">
        <div class="container">
          <div class="row g-5">
            <!-- Colonne de gauche - Détails de la réservation -->
            <div class="col-lg-8">
              <div class="de-box mb25">
                <div
                  class="d-flex justify-content-between align-items-center mb-4"
                >
                  <h3>Informations de réservation</h3>
                  <div id="reservation-status" class="badge rounded-pill"></div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="de-spec">
                      <div class="d-row">
                        <span class="d-title">Numéro de réservation</span>
                        <span class="d-value" id="reservation-id"></span>
                      </div>
                      <div class="d-row">
                        <span class="d-title">Date de création</span>
                        <span class="d-value" id="reservation-created"></span>
                      </div>
                      <div class="d-row">
                        <span class="d-title">Date de retrait</span>
                        <span class="d-value" id="date-debut"></span>
                      </div>
                      <div class="d-row">
                        <span class="d-title">Date de retour</span>
                        <span class="d-value" id="date-fin"></span>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="de-spec">
                      <div class="d-row">
                        <span class="d-title">Adresse de retrait</span>
                        <span class="d-value" id="adresse-retrait"></span>
                      </div>
                      <div class="d-row">
                        <span class="d-title">Adresse de dépôt</span>
                        <span class="d-value" id="adresse-depot"></span>
                      </div>
                      <div class="d-row">
                        <span class="d-title">Montant total</span>
                        <span class="d-value" id="montant-total"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Section Véhicule -->
              <div class="de-box mb25">
                <h4 class="mb-4">Détails du véhicule</h4>
                <div id="vehicle-details" class="row">
                  <!-- Les détails seront injectés ici via JS -->
                </div>
              </div>
            </div>

            <!-- Colonne de droite - Actions -->
            <div class="col-lg-4">
              <div class="de-box mb25">
                <h4 class="mb-4">Actions</h4>
                <div id="action-buttons">
                  <!-- Les boutons seront générés dynamiquement -->
                </div>
                <div class="mt-4">
                  <a
                    href="espace_locataire.html"
                    class="btn-main btn-fullwidth"
                  >
                    Retour à mes réservations
                  </a>
                </div>
              </div>

              <!-- Section Propriétaire -->
              <div class="de-box">
                <h4 class="mb-4">Contact du propriétaire</h4>
                <div id="owner-details">
                  <!-- Les détails seront injectés ici via JS -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Mêmes scripts JS que car-single.html -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="js/plugins.js"></script>
    <script src="js/designesia.js"></script>
    <script>
      $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const reservationId = urlParams.get("id");
        const token = localStorage.getItem("token");

        // if (!reservationId || !token) {
        //     window.location.href = 'index.html';
        //     return;
        // }

        // Fonction de formatage
        const formatDate = (dateString) =>
          new Date(dateString).toLocaleDateString("fr-FR", {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });

        // Charger les détails de la réservation
        $.ajax({
          url: `http://localhost:5000/api/locations/${reservationId}`,
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
          success: function (response) {
            const reservation = response.data;

            // Mettre à jour les informations principales
            $("#reservation-id").text(reservation._id);
            $("#reservation-created").text(formatDate(reservation.createdAt));
            $("#date-debut").text(formatDate(reservation.dateDebut));
            $("#date-fin").text(formatDate(reservation.dateFin));
            $("#adresse-retrait").text(reservation.adresseRetrait);
            $("#adresse-depot").text(reservation.adresseDepot);
            $("#montant-total").text(
              `${reservation.montantTotal.toFixed(2)} €`
            );

            // Mettre à jour le statut
            const statusConfig = {
              en_attente: { text: "En attente", class: "bg-warning" },
              acceptee: { text: "Confirmée", class: "bg-success" },
              refusee: { text: "Refusée", class: "bg-danger" },
              terminee: { text: "Terminée", class: "bg-primary" },
              annulee: { text: "Annulée", class: "bg-secondary" },
            };
            const status = statusConfig[reservation.statut];
            $("#reservation-status").text(status.text).addClass(status.class);

            // Afficher les détails du véhicule
            const vehicleHtml = `
                    <div class="col-md-4">
                        <img src="http://localhost:5000/uploads/voitures/${reservation.annonce.voiture.images[0]}" 
                             class="img-fluid rounded mb-3" 
                             alt="${reservation.annonce.voiture.marque}">
                    </div>
                    <div class="col-md-8">
                        <h5>${reservation.annonce.voiture.marque} ${reservation.annonce.voiture.modele}</h5>
                        <div class="de-spec">
                            <div class="d-row">
                                <span class="d-title">Année</span>
                                <span class="d-value">${reservation.annonce.voiture.annee}</span>
                            </div>
                            <div class="d-row">
                                <span class="d-title">Carburant</span>
                                <span class="d-value">${reservation.annonce.voiture.carburant}</span>
                            </div>
                            <div class="d-row">
                                <span class="d-title">Transmission</span>
                                <span class="d-value">${reservation.annonce.voiture.transmission}</span>
                            </div>
                        </div>
                    </div>
                `;
            $("#vehicle-details").html(vehicleHtml);

            // Afficher les informations du propriétaire
            const ownerHtml = `
                    <div class="d-flex align-items-center mb-3">
                        <img src="http://localhost:5000/uploads/utilisateurs/${
                          reservation.annonce.proprietaire.photo ||
                          "default.jpg"
                        }" 
                             class="rounded-circle me-3" 
                             width="60" 
                             alt="${reservation.annonce.proprietaire.nom}">
                        <div>
                            <h5 class="mb-0">${
                              reservation.annonce.proprietaire.nom
                            }</h5>
                            <div class="text-muted">${
                              reservation.annonce.proprietaire.email
                            }</div>
                            <div>${
                              reservation.annonce.proprietaire.telephone
                            }</div>
                        </div>
                    </div>
                `;
            $("#owner-details").html(ownerHtml);

            // Gérer les boutons d'action
            let actions = "";
            if (reservation.statut === "en_attente") {
              actions = `
                        <button class="btn btn-danger btn-fullwidth mb-2 annuler-btn">
                            Annuler la réservation
                        </button>
                    `;
            }
            $("#action-buttons").html(actions);
          },
          error: function (err) {
            console.error(err);
            // window.location.href = '404.html';
          },
        });

        // Gestion de l'annulation
        $(document).on("click", ".annuler-btn", function () {
          if (confirm("Êtes-vous sûr de vouloir annuler cette réservation ?")) {
            $.ajax({
              url: `http://localhost:5000/api/locations/${reservationId}/annuler`,
              method: "PATCH",
              headers: { Authorization: `Bearer ${token}` },
              success: function () {
                location.reload();
              },
              error: function (err) {
                alert(
                  "Erreur lors de l'annulation : " + err.responseJSON.message
                );
              },
            });
          }
        });
      });
    </script>
  </body>
</html>
