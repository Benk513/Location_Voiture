<script>
    const token = localStorage.getItem("token");
    const role= localStorage.getItem("role")
    if (!token) {
      window.location.href = "index.html"; // Redirige vers login
    }
    if(role !=="proprietaire"){
         window.location.href = "index.html";
    }
 
  </script>
  <!DOCTYPE html>
<html lang="zxx">
  <head>
    <title>Rentaly - Multipurpose Vehicle Car Rental Website Template</title>
    <link rel="icon" href="images/icon.png" type="image/gif" sizes="16x16" />
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta
      content="Rentaly - Multipurpose Vehicle Car Rental Website Template"
      name="description"
    />
    <meta content="" name="keywords" />
    <meta content="" name="author" />
    <!-- CSS Files
    ================================================== -->
    <link
      href="css/bootstrap.min.css"
      rel="stylesheet"
      type="text/css"
      id="bootstrap"
    />
    <link href="css/mdb.min.css" rel="stylesheet" type="text/css" id="mdb" />
    <link href="css/plugins.css" rel="stylesheet" type="text/css" />
    <link href="css/style.css" rel="stylesheet" type="text/css" />
    <link href="css/coloring.css" rel="stylesheet" type="text/css" />
    <!-- color scheme -->
    <link
      id="colors"
      href="css/colors/scheme-01.css"
      rel="stylesheet"
      type="text/css"
    />
  </head>

  <body>
    <div id="wrapper">
      <!-- page preloader begin -->
      <div id="de-preloader"></div>
      <!-- page preloader close -->

      <!-- header begin -->
      <header class="transparent scroll-light has-topbar">
        <div id="topbar" class="topbar-dark text-light">
          <div class="container">
            <div class="topbar-left xs-hide">
              <div class="topbar-widget">
                <div class="topbar-widget">
                  <a href="#"><i class="fa fa-phone"></i>+208 333 9296</a>
                </div>
                <div class="topbar-widget">
                  <a href="#"
                    ><i class="fa fa-envelope"></i>contact@rentaly.com</a
                  >
                </div>
                <div class="topbar-widget">
                  <a href="#"
                    ><i class="fa fa-clock-o"></i>Mon - Fri 08.00 - 18.00</a
                  >
                </div>
              </div>
            </div>

            <div class="topbar-right">
              <div class="social-icons">
                <a href="#"><i class="fa fa-facebook fa-lg"></i></a>
                <a href="#"><i class="fa fa-twitter fa-lg"></i></a>
                <a href="#"><i class="fa fa-youtube fa-lg"></i></a>
                <a href="#"><i class="fa fa-pinterest fa-lg"></i></a>
                <a href="#"><i class="fa fa-instagram fa-lg"></i></a>
              </div>
            </div>
            <div class="clearfix"></div>
          </div>
        </div>
        <div class="container">
          <div class="row">
            <div class="col-md-12">
              <div class="de-flex sm-pt10">
                <div class="de-flex-col">
                  <div class="de-flex-col">
                    <!-- logo begin -->
                    <div id="logo">
                      <a href="index.html">
                        <img
                          class="logo-1"
                          src="images/logo-light.png"
                          alt=""
                        />
                        <img class="logo-2" src="images/logo.png" alt="" />
                      </a>
                    </div>
                    <!-- logo close -->
                  </div>
                </div>
                <div class="de-flex-col header-col-mid">
                  <ul id="mainmenu">
                    <li>
                      <a class="menu-item" href="index.html">Accueil</a>
                    </li>
                    <li>
                      <a class="menu-item" href="cars.html">Voitures</a>
                    </li>
                    <li>
                      <a class="menu-item" href="cars.html">Contact</a>
                    </li>
                  </ul>
                </div>
                <div class="de-flex-col">

<div class="menu_side_area " id="loginUI">
                    <a href="login.html" class="btn-main">Se connecter</a>
                    <span id="menu-btn"></span>
                  </div>
                                <div class="menu_side_area" id="accountUI">
                                    <div class="de-login-menu">

                                        <span id="de-click-menu-profile" class="de-menu-profile">                           
                                            <img src="images/profile/1.jpg" class="img-fluid photo" alt="">
                                        </span>

                                        

                                        <div id="de-submenu-profile" class="de-submenu">
                                            <div class="d-name">
                                                <h4 class="nom">Monica Lucas</h4>
                                                <span class="text-gray email"></span>
                                                <span class="text-gray role"></span>
                                            </div>

                                            <div class="d-line"></div>

                                            <ul class="menu-col">
                                                <li><a href="account-dashboard.html" id="accountRedirect"><i class="fa fa-home"></i>Tableau de bord</a></li>
                                                <li><a href="account-profile.html"><i class="fa fa-user"></i>Mon profile</a></li>
                                                  <li><span class="deconnexion"><i class="fa fa-sign-out"></i> Se deconnecter</span></li> 
                                            </ul>
                                        </div>
                                        <span id="menu-btn"></span>
                                    </div>
                                </div>
                            </div>
              </div>
            </div>
          </div>
        </div>
      </header>
      <!-- header close -->
      <!-- content begin -->
      <div class="no-bottom no-top zebra" id="content">
        <div id="top"></div>

        <!-- section begin -->
        <section id="subheader" class="jarallax text-light">
          <img src="images/background/14.jpg" class="jarallax-img" alt="" />
          <div class="center-y relative text-center">
            <div class="container">
              <div class="row">
                <div class="col-md-12 text-center">
                  <h1>Mes Annonces</h1>
                </div>
                <div class="clearfix"></div>
              </div>
            </div>
          </div>
        </section>
        <!-- section close -->

        <section id="section-settings" class="bg-gray-100">
          <div class="container">
            <div class="row">
              <div class="col-lg-3 mb30">
                <div class="card p-4 rounded-5">
                  <div class="profile_avatar">
                    <div class="profile_img">
                      <img
                        src="images/profile/1.jpg"
                        class="img-fluid photo"
                        alt=""
                      />
                    </div>
                    <div class="profile_name">
                      <h4 class="nom">
                        Monica Lucas
                        <span class="email profile_username text-gray"
                          >monica@rentaly.com</span
                        >
                      </h4>
                    </div>
                  </div>
                  <div class="spacer-20"></div>
                  <ul class="menu-col">
                    <li>
                      <a href="account-dashboard.html"
                        ><i class="fa fa-home"></i>Tableau de bord</a
                      >
                    </li>
                    <li>
                      <a href=""><i class="fa fa-user"></i>Mon profil</a>
                    </li>
                    <li>
                      <a href="account-booking.html"
                        ><i class="fa fa-calendar"></i>Mes locations</a
                      >
                    </li>
                    <li>
                      <a href="account-favorite.html" class="active"
                        ><i class="fa fa-calendar"></i>Mes voitures</a
                      >
                    </li>
                    <li>
                      <span class="deconnexion"
                        ><i class="fa fa-sign-out"></i>Se deconnecter</span
                      >
                    </li>
                  </ul>
                </div>
              </div>
              <div class="col-lg-9">
                <div class="row">
                  <!-- <a class="btn-main mb-4" href="ajouter_annonce.html"
                    >Ajouter une annonce</a
                  > -->

                  <div class="col-lg-12" id="mes-voitures-container">
                    <div class="de-item-list no-border mb30">
                      <div class="d-img">
                        <img
                          src="images/cars/jeep-renegade.jpg"
                          class="img-fluid"
                          alt=""
                        />
                      </div>
                      <div class="d-info">
                        <div class="d-text">
                          <h4>Jeep Renegade</h4>
                          <div class="d-atr-group">
                            <ul class="d-atr">
                              <li><span>Sieges:</span></li>
                              <li><span>Marque:</span></li>
                              <li><span>Portes:</span></li>
                              <li><span>Kilometrage:</span></li>
                              <li><span>Horsepower:</span></li>
                              <li><span>Modele:</span></li>
                              <li><span>Transmission:</span></li>
                              <li><span>Carburant:</span></li>
                              <li><span>Statut:</span></li>
                            </ul>
                          </div>
                        </div>
                      </div>
                      <div class="d-price">
                        Tarif journalier <span>$265</span>
                        <a class="button-danger" href="car-single.html"
                          >Supprimer</a
                        >
                        <a class="btn-main" href="car-single.html">Modifier</a>
                      </div>
                      <div class="clearfix"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
      <!-- content close -->

      <a href="#" id="back-to-top"></a>
    </div>

    <!-- Javascript Files
    ================================================== -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="js/plugins.js"></script>
    <script src="js/designesia.js"></script>

    <script>
      $(".deconnexion").click(function () {
        alert("À bientôt !");
        localStorage.clear();
        window.location.href = "login.html";
      });
    </script>
  <script>
        $(document).ready(function () {
            // Charger les données du profil

            const userProfileUrl = "http://localhost:5000/uploads/utilisateurs/";
              const token = localStorage.getItem("token");

    if (!token) {
      // Aucune connexion
      $("#loginUI").show();
      $("#accountUI").hide();
      return;
    }else{
      
      $("#accountUI").show();
      $("#loginUI").hide();
    }
        $.ajax({
          url: "http://localhost:5000/api/utilisateurs/obtenirMonProfil",
          method: "GET",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("token"),
          },
          success: function (user) {
              const profileUrl = userProfileUrl + user?.data.photo;
            console.log(user?.data.photo)
            $(".nom").text(user?.data?.nom);
            $(".email").text(user?.data.email);
            $(".photo").attr("src", profileUrl);
            $("#photo").attr("src", profileUrl);
            $("#pays").text(user?.data.pays || "Non renseigné.");
            $("#dateNaissance").text(user?.data.dateNaissance || "Non renseigné.");
            $("#biographie").text(user?.data.biographie || "Aucune biographie fournie.");
            $("#adresse").text(user?.data.adresse || "Non renseigné.");
            $("#telephone").text(user?.data.telephone || "Non renseignné.");
            $(".role").text(user?.data.role || "Non renseignné.");
            $("#sexe").text(user?.data.sexe || "Non renseignné.");


                 // Affichage conditionnel
      if (user?.data.role === "admin" || user?.data.role === "ambassadeur" || user?.data.role === "etudiant") {
        $("#info-administrative").hide();     // Masquer mot de passe
        $("#info-academique").hide();     // Masquer mot de passe
        $("#saveBtn").hide();         // Masquer bouton "Enregistrer"
      }

      if(user?.data.role ==="proprietaire"){
        $("#accountRedirect").attr("href", "account-dashboard.html");
        $("#accountRedirect").text("Tableau de bord");
        
      }else{
        
        $("#accountRedirect").attr("href", "espace_locataire.html");
        $("#accountRedirect").text("Mon compte");
      }
          },
          error: function () {
              console.log("Erreur lors du chargement du profil !");
            },
        });})
        </script>

    <!-- <script>
      // Fonction principale de chargement
      function chargerAnnonces() {
        // --- NOMBRE DE SIEGES ---

        $.ajax({
          url: "http://localhost:5000/api/voitures/mesVoitures",
          type: "GET",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("token"),
          },
          success: function (res) {
            const baseUrl = "http://localhost:5000/uploads/voitures/";
            const annonces = res.data;
            console.log(res.data);
            const conteneur = $(".col-lg-9 .row");
            conteneur.empty(); // vide avant remplissage

            if (!annonces || annonces.length === 0) {
              conteneur.append("<p>Aucune annonce trouvée.</p>");
              return;
            }

            annonces.forEach((annonce) => {
              const voitureUrl = baseUrl + annonce.voiture.images[0];
              const voiture = annonce.voiture;
              const html = `
              <div class="col-xl-4 col-lg-6">
                <div class="de-item mb30">
                  <div class="d-img">
                    <img src="${voitureUrl}" class="img-fluid" alt="">
                  </div>
                  <div class="d-info">
                    <div class="d-text">
                      <h4>${voiture.nom}</h4>
                      <div class="d-item_like">
                        <i class="fa fa-heart"></i><span>0</span>
                      </div>
                      <div class="d-atr-group">
                        <span class="d-atr"><img src="images/icons/1-green.svg" alt="">${voiture.nombreDeSieges}</span>
                        <span class="d-atr"><img src="images/icons/2-green.svg" alt="">${voiture.nombreDePortes}</span>
                        <span class="d-atr"><img src="images/icons/3-green.svg" alt="">${voiture.transmission}</span>
                        <span class="d-atr"><img src="images/icons/4-green.svg" alt="">${voiture.marque}</span>
                      </div>
                      <div class="d-price">
                        A partir de <span>$${voiture.tarifParJour}</span>
                        <a class="btn-main" href="car-single.html?id=${annonce._id}">Reserver maintenant</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
              conteneur.append(html);
            });
          },
          error: function (err) {
            console.error("Erreur :", err);
          },
        });
      }

      // Chargement initial
      $(document).ready(function () {
        chargerAnnonces();
      });
    </script> -->

    <!-- <script>
      $(document).ready(function () {
        $.ajax({
          url: "http://localhost:5000/api/voitures/mesVoitures",
          method: "GET",
          dataType: "json",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("token"),
          },

          success: function (res) {
            const $container = $("#mes-voitures-container");
            $container.empty();
            const voitures = res.data;

            if (!voitures.length) {
              $container.append("<p>Aucune voiture trouvée.</p>");
              return;
            }

            voitures.forEach(function (voiture) {
              const image = voiture.images?.[0] || "default.jpg";

              console.log(voiture);
              const html = `
               
                <div class="de-item-list no-border mb30">
                  <div class="d-img">
                    <img src="http://localhost:5000/uploads/voitures/${image}" class="img-fluid" alt="${
                voiture.nom
              }" />
                  </div>
                  <div class="d-info">
                    <div class="d-text">
                      <h4>${voiture.nom}</h4>
                      <div class="d-atr-group">
                        <ul class="d-atr">
                          <li><span>Sieges:</span> ${
                            voiture.nombreDeSieges
                          }</li>
                          <li><span>Marque:</span> ${voiture.marque}</li>
                          <li><span>Portes:</span> ${
                            voiture.nombreDePortes
                          }</li>
                          <li><span>Kilometrage:</span> ${
                            voiture.kilometrage
                          }</li>
                          <li><span>Horsepower:</span> ${
                            voiture.horsepower || "N/A"
                          }</li>
                          <li><span>Modele:</span> ${voiture.modele}</li>
                          <li><span>Transmission:</span> ${
                            voiture.transmission
                          }</li>
                          <li><span>Carburant:</span> ${voiture.carburant}</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="d-price">
                    Tarif journalier <span>$${voiture.tarifParJour}</span>
                    <a class="button-danger" href="/voiture/${
                      voiture._id
                    }/supprimer">Supprimer</a>
                    <a class="btn-main" href="/voiture/${
                      voiture._id
                    }/modifier">Modifier</a>
                  </div>
                  <div class="clearfix"></div>
                </div>
               
            `;

              $container.append(html);
            });
          },
          error: function () {
            console.error(
              "Erreur lors du chargement des voitures du propriétaire."
            );
            $("#mes-voitures-container").html("<p>Erreur de chargement.</p>");
          },
        });
      });
    </script> -->

    <script>
      $(document).ready(function () {
        function chargerMesVoitures() {
          $.ajax({
            url: "http://localhost:5000/api/annonces/listerMesAnnonces",
            method: "GET",
            dataType: "json",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },

            success: function (res) {
              const $container = $("#mes-voitures-container");
              $container.empty();
              const voitures = res.data;

              console.log(voitures);

              if (!voitures.length) {
                $container.append("<p>Aucune voiture trouvée.</p>");
                return;
              }

              voitures.forEach(function (voiture) {
                const image = voiture.voiture.images?.[0] || "default.jpg";

                const html = `
                    <div class="de-item-list no-border mb30" data-id="${
                      voiture._id
                    }">
                      <div class="d-img">
                        <img src="http://localhost:5000/uploads/voitures/${image}" class="img-fluid" alt="${
                  voiture.nom
                }" />
                      </div>
                      <div class="d-info">
                        <div class="d-text">
                          <h4>${voiture.voiture.nom}</h4>
                          <div class="d-atr-group">
                            <ul class="d-atr">
                              <li><span>Date de debut:</span> ${new Date(
                                voiture.dateDebut
                              ).toLocaleDateString("fr-FR", {
                                year: "numeric",
                                month: "numeric",
                                day: "numeric",
                              })}</li>
                              <li><span>Date de fin:</span> ${new Date(
                                voiture.dateFin
                              ).toLocaleDateString("fr-FR", {
                                year: "numeric",
                                month: "numeric",
                                day: "numeric",
                              })}</li>
                              <li><span>Lieu:</span> ${voiture.lieu}</li>
                              <li><span>Description:</span> ${
                                voiture.description || "N/A"
                              }</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                      <div class="d-price">
                        Tarif journalier <span>$${
                          voiture.voiture.tarifParJour
                        }</span>
                        <a href="#" class="button-danger btn-supprimer-voiture" data-id="${
                          voiture._id
                        }">Supprimer</a>
                        <a class="btn-main" href="/voiture/${
                          voiture._id
                        }/modifier">Modifier</a>
                      </div>
                      <div class="clearfix"></div>
                    </div>
                  `;
                $container.append(html);
              });
            },
            error: function () {
              console.error(
                "Erreur lors du chargement des voitures du propriétaire."
              );
              $("#mes-voitures-container").html("<p>Erreur de chargement.</p>");
            },
          });
        }

        // Chargement initial
        chargerMesVoitures();

        // Suppression en délégation
        $("#mes-voitures-container").on(
          "click",
          ".btn-supprimer-voiture",
          function (e) {
            e.preventDefault();
            const id = $(this).data("id");

            if (confirm("Êtes-vous sûr de vouloir supprimer cette voiture ?")) {
              $.ajax({
                url: `http://localhost:5000/api/annonces//${id}`,
                method: "DELETE",
                headers: {
                  Authorization: "Bearer " + localStorage.getItem("token"),
                },
                success: function () {
                  $(`.de-item-list[data-id="${id}"]`).remove(); // retirer du DOM
                  alert("Voiture supprimée avec succès !");
                },
                error: function () {
                  alert("Erreur lors de la suppression.");
                },
              });
            }
          }
        );
      });
    </script>
  </body>
</html>
